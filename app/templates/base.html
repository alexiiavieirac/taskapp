<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Household Tasks{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Inclua a biblioteca cliente do Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

    <!-- Cabe√ßalho para scripts adicionais da p√°gina espec√≠fica (se necess√°rio) -->
    {% block head_scripts %}{% endblock %}

    <style>
        /* Estilos adicionados para esconder o input type="date" de forma acess√≠vel */
        .visually-hidden {
            position: absolute !important;
            height: 1px; width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px); /* IE6, IE7 */
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap; /* keep all text on one line */
        }
    </style>
</head>
<body>

    <!-- Navbar - Comum a todas as p√°ginas -->
    <header>
        <h2>Household Tasks</h2>
        <div class="navbar-actions">
            {% if current_user.is_authenticated %}
                <div class="navbar-user">
                    {% if current_user.avatar %}
                        <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}" alt="Avatar" class="avatar-pequeno">
                    {% endif %}
                    <span class="user-welcome">Bem-vindo(a), {{ current_user.nome }} üëãüèª</span>
                    <form action="{{ url_for('main.logout') }}" method="GET">
                        <button class="logout-btn" type="submit">Sair</button>
                    </form>
                </div>
            {% endif %}
        </div>
    </header>

    <!-- Menu de Op√ß√µes - Comum a todas as p√°ginas -->
    <div class="menu-opcoes">
        <!-- √çcone do menu com badge de notifica√ß√£o -->
        <button class="menu-btn" onclick="toggleMenu(event)">
            ‚ò∞ Menu
            {# total_notificacoes √© injetado pelo context_processor #}
            {% if total_notificacoes is defined and total_notificacoes > 0 %}
                <span class="notificacao-badge">{{ total_notificacoes }}</span>
            {% endif %}
        </button>

        <div class="menu-dropdown dropdown" id="menuDropdown">
            <nav>
                <a href="{{ url_for('main.grupo') }}">üë• Grupo</a>
            </nav>
            <a href="{{ url_for('main.conexoes') }}">üîÑ Conex√µes</a>
            <a href="{{ url_for('main.pedidos_grupo') }}">
                üì® Pedidos Grupo
                {# notificacoes.grupo √© injetado pelo context_processor #}
                {% if notificacoes is defined and notificacoes.grupo > 0 %}
                    <span class="notificacao-label">{{ notificacoes.grupo }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('main.pedidos_seguir') }}">
                üôã Pedidos
                {# notificacoes.seguidores √© injetado pelo context_processor #}
                {% if notificacoes is defined and notificacoes.seguidores > 0 %}
                    <span class="notificacao-label">{{ notificacoes.seguidores }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('main.ranking') }}">üèÜ Ranking</a>
            <a href="{{ url_for('main.historico') }}">üóìÔ∏è Hist√≥rico</a>
            <a href="{{ url_for('main.tarefas_diarias') }}">üìù Tarefas Di√°rias</a>
            <a href="{{ url_for('main.configuracoes') }}">‚öôÔ∏è Configura√ß√µes</a>
        </div>
    </div>

    <!-- Conte√∫do espec√≠fico de cada p√°gina ser√° inserido aqui -->
    <div class="container">
        {% block content %}{% endblock %}
    </div>
    
    <!-- Chat Widget - Comum a todas as p√°ginas -->
    {% if current_user.is_authenticated and current_user.grupo_id %}
    <div class="chat-widget">
        <button class="chat-bubble" id="chatBubble">üí¨</button>
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <h3>Chat do Grupo</h3>
                <button class="group-info-btn" id="groupInfoBtn">‚ÑπÔ∏è</button> {# Bot√£o de info #}
                <button class="chat-close-btn" id="chatCloseBtn">‚úñ</button>
            </div>
            
            {# Painel de informa√ß√µes do grupo - Escondido por padr√£o #}
            <div class="group-info-panel" id="groupInfoPanel">
                {# current_user_group_name √© injetado pelo context_processor #}
                <h4>Grupo: {{ current_user_group_name }}</h4>
                <h5>Membros do Grupo:</h5>
                <ul>
                    <!-- Exibe o usu√°rio atual -->
                    <li>{{ current_user.nome }} (Voc√™)</li>
                    <!-- Itera sobre os membros do grupo, excluindo o usu√°rio atual -->
                    {# grupo_members √© injetado pelo context_processor #}
                    {% if grupo_members %}
                        {% for member in grupo_members %}
                            {% if member.id != current_user.id %} {# Garante que o usu√°rio atual n√£o seja duplicado #}
                                <li>{{ member.nome }}</li>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <li>Nenhum outro membro encontrado.</li>
                    {% endif %}
                </ul>
            </div>

            <div class="chat-messages">
                <!-- As mensagens do chat ser√£o adicionadas aqui pelo JavaScript -->
                <div class="chat-message-item other">
                    <span class="chat-message-author">Sistema</span>
                    <p>Conectando ao chat do grupo...</p>
                    {# datetime √© injetado pelo context_processor #}
                    <span class="chat-message-time">{{ datetime.utcnow().strftime('%H:%M') }}</span>
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="text" placeholder="Digite sua mensagem..." id="chatMessageInput">
                <button id="chatSendBtn">Enviar</button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Scripts JavaScript comuns a todas as p√°ginas e do chat -->
    <script>
        // Vari√°vel global usada por manipuladores de eventos inline e event listeners
        let menuFixado = false;

        // Fun√ß√£o de toggle do menu (chamada por onclick="toggleMenu(event)")
        function toggleMenu(event) {
            event.stopPropagation(); // Evita que o evento de clique se propague para o window
            const menu = document.getElementById("menuDropdown");
            if (menu) { // Garante que o menu exista
                menuFixado = !menuFixado;
                menu.style.display = menuFixado ? "block" : "none";
            }
        }

        // Tudo que manipula o DOM diretamente deve estar dentro de DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // --- L√≥gica do Menu Dropdown (hover e fechar ao clicar fora) ---
            const menuOpcoes = document.querySelector('.menu-opcoes');
            const menuDropdown = document.getElementById("menuDropdown");

            if (menuOpcoes && menuDropdown) {
                // Eventos de hover para o menu
                menuOpcoes.addEventListener('mouseenter', () => {
                    if (!menuFixado) { // Se o menu n√£o estiver fixado, abre ao passar o mouse
                        menuDropdown.style.display = "block";
                    }
                });

                menuOpcoes.addEventListener('mouseleave', () => {
                    if (!menuFixado) { // Se o menu n√£o estiver fixado, fecha ao tirar o mouse
                        menuDropdown.style.display = "none";
                    }
                });

                // Evento para fechar o menu ao clicar fora dele
                window.addEventListener("click", function(event) {
                    // Verifica se o clique n√£o foi dentro da √°rea do menuOpcoes E n√£o foi no bot√£o que abre o menu
                    if (!event.target.closest('.menu-opcoes') && !event.target.classList.contains('menu-btn')) {
                        if (menuDropdown) { // Garante que o menuDropdown exista
                            menuFixado = false; // Desfixa o menu
                            menuDropdown.style.display = "none";
                        }
                    }
                });
            }

            // --- L√≥gica do Chat Widget (Abertura/Fechamento do Painel) ---
            const chatBubble = document.getElementById('chatBubble');
            const chatPanel = document.getElementById('chatPanel');
            const chatCloseBtn = document.getElementById('chatCloseBtn');
            const groupInfoBtn = document.getElementById('groupInfoBtn'); // Novo bot√£o 'i'
            const groupInfoPanel = document.getElementById('groupInfoPanel'); // Novo painel de info

            if (chatBubble && chatPanel && chatCloseBtn && groupInfoBtn && groupInfoPanel) {
                chatBubble.addEventListener('click', function() {
                    chatPanel.classList.toggle('open');
                    chatBubble.style.display = chatPanel.classList.contains('open') ? 'none' : 'flex';
                });

                chatCloseBtn.addEventListener('click', function() {
                    chatPanel.classList.remove('open');
                    groupInfoPanel.classList.remove('open-info'); // Fecha o painel de info se estiver aberto
                    chatBubble.style.display = 'flex';
                });

                // Nova l√≥gica para o bot√£o "i"
                groupInfoBtn.addEventListener('click', function() {
                    groupInfoPanel.classList.toggle('open-info');
                });
                
                // Esconde o painel por padr√£o, mas mant√©m a bolha vis√≠vel
                chatPanel.classList.remove('open');
                groupInfoPanel.classList.remove('open-info');
                chatBubble.style.display = 'flex';
            }

            // --- L√≥gica do Socket.IO para o Chat ---
            // Apenas se o usu√°rio estiver autenticado e tiver um grupo_id
            {% if current_user.is_authenticated and current_user.grupo_id %}
                const socket = io(); // Conecta ao servidor Socket.IO

                // Evento de conex√£o
                socket.on('connect', function() {
                    console.log('Conectado ao servidor Socket.IO!');
                    // Envia um evento para o servidor para entrar na sala do grupo
                    socket.emit('join', { group_id: {{ current_user.grupo_id }} });
                });

                // Evento para receber mensagens
                socket.on('message', function(data) {
                    addMessageToChat(data.username, data.message, data.user_id, data.timestamp);
                });

                // L√≥gica para enviar mensagem
                const chatMessageInput = document.getElementById('chatMessageInput');
                const chatSendBtn = document.getElementById('chatSendBtn');

                if (chatMessageInput && chatSendBtn) {
                    chatSendBtn.addEventListener('click', function() {
                        const message = chatMessageInput.value.trim();
                        if (message) {
                            // Envia a mensagem para o servidor
                            socket.emit('send_message', { message: message, group_id: {{ current_user.grupo_id }} });
                            chatMessageInput.value = ''; // Limpa o input
                        }
                    });

                    // Permite enviar mensagem ao pressionar Enter
                    chatMessageInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            chatSendBtn.click();
                        }
                    });
                }

                // Fun√ß√£o para adicionar mensagem ao chat
                // Mude a assinatura da fun√ß√£o de (username, message, is_self, timestamp)
                // para (username, message, sender_user_id, timestamp)
                function addMessageToChat(username, message, sender_user_id, timestamp) { // ALTERADO AQUI
                    const chatMessagesContainer = document.querySelector('.chat-messages');
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message-item');

                    // --- NOVA L√ìGICA: Determinar se a mensagem √© do pr√≥prio usu√°rio ---
                    const currentUserId = {{ current_user.id }}; // ID do usu√°rio logado (Lekinha, no seu caso)
                    const is_self = sender_user_id === currentUserId; // Compara o ID do remetente com o ID do usu√°rio atual
                    // ------------------------------------------------------------------

                    if (is_self) { // Agora 'is_self' √© determinado no cliente
                        messageElement.classList.add('self');
                    } else {
                        messageElement.classList.add('other');
                    }

                    const authorSpan = document.createElement('span');
                    authorSpan.classList.add('chat-message-author');
                    authorSpan.textContent = username;

                    const messageParagraph = document.createElement('p');
                    messageParagraph.textContent = message;

                    const timeSpan = document.createElement('span');
                    timeSpan.classList.add('chat-message-time');
                    const date = new Date(timestamp);
                    timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    messageElement.appendChild(authorSpan);
                    messageElement.appendChild(messageParagraph);
                    messageElement.appendChild(timeSpan);
                    chatMessagesContainer.appendChild(messageElement);
                    
                    // Rolagem autom√°tica para a √∫ltima mensagem
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                
                // Carregar hist√≥rico de mensagens (pode ser feito via Socket.IO ou rota Flask normal)
                // Carregar hist√≥rico de mensagens (pode ser feito via Socket.IO ou rota Flask normal)
                socket.on('history', function(messages) {
                    const chatMessagesContainer = document.querySelector('.chat-messages');
                    chatMessagesContainer.innerHTML = ''; // Limpa as mensagens de exemplo/placeholder
                    // Voc√™ j√° tinha uma l√≥gica de 'is_self' aqui, vamos ajust√°-la para usar o ID
                    const currentUserId = {{ current_user.id }}; // Adicione esta linha tamb√©m para o hist√≥rico

                    messages.forEach(msg => {
                        // Verifique se a mensagem foi enviada pelo usu√°rio atual
                        const is_self_from_history = msg.user_id === currentUserId; // Usa o ID do hist√≥rico
                        // Envie 'msg.user_id' (o ID do remetente) para a fun√ß√£o
                        addMessageToChat(msg.username, msg.message, msg.user_id, msg.timestamp); // ALTERADO AQUI
                    });
                });

            {% endif %}
        });
    </script>
    
    <!-- Scripts espec√≠ficos da p√°gina que estende base.html -->
    {% block scripts %}{% endblock %}

</body>
</html>