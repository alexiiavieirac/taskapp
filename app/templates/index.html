{% extends "base.html" %}

{% block title %}Minhas Tarefas{% endblock %}

{% block content %}
    <h1>Minhas Tarefas</h1>

    {# Navega√ß√£o de data #}
    <div class="date-navigation">
        <div class="date-nav-left-group">
            {# Link para o dia anterior #}
            <a href="{{ url_for('main.index', date=(current_display_date - timedelta(days=1)).strftime('%Y-%m-%d')) }}" class="date-nav-item date-nav-arrow">‚üµ</a>
            
            {# T√≠tulo da data atual - CLIC√ÅVEL PARA ABRIR O CALEND√ÅRIO #}
            <span class="date-nav-item date-nav-display" id="dateDisplayButton" style="cursor: pointer;">{{ display_date_text }}</span>
            
            {# Link para o pr√≥ximo dia - S√≥ aparece se a data atual n√£o for o dia de hoje #}
            {% if current_display_date < today_date_utc %}
                <a href="{{ url_for('main.index', date=(current_display_date + timedelta(days=1)).strftime('%Y-%m-%d')) }}" class="date-nav-item date-nav-arrow">‚ü∂</a>
            {% endif %}
        </div>

        {# Bot√£o "Hoje" para voltar ao dia atual - S√ì APARECE se a data exibida n√£o for hoje #}
        {% if current_display_date != today_date_utc %}
            <a href="{{ url_for('main.index', date=today_date_utc.strftime('%Y-%m-%d')) }}" class="date-nav-item date-nav-today">Hoje</a>
        {% endif %}
    </div>
    
    {# Input de data escondido para o calend√°rio #}
    <input type="date" id="datePicker" class="visually-hidden">

    {# Formul√°rio de adicionar tarefa - Vis√≠vel APENAS se n√£o for uma data passada #}
    {% if not is_past_date %}
        <form method="POST" enctype="multipart/form-data">
            <input type="text" name="descricao" placeholder="Nova Tarefa" required>
            <input type="file" name="imagem" accept="image/*">
            <button type="submit">Adicionar</button>
        </form>
    {% else %}
        <p style="text-align: center; color: #888; margin-bottom: 20px;">N√£o √© poss√≠vel adicionar tarefas para dias passados.</p>
    {% endif %}
    
    {% for tarefa in tarefas %}
        <div class="tarefa-item">
            <!-- Conte√∫do da tarefa (descri√ß√£o + imagem) -->
            <div style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
                <div class="descricao {% if tarefa.concluida %}concluida{% endif %}">
                    {% if tarefa.concluida %}
                        <s>{{ tarefa.descricao }}</s>
                    {% else %}
                        {{ tarefa.descricao }}
                    {% endif %}
                </div>

                {% if tarefa.imagem %}
                <div class="tarefa-imagem-container">
                    <img src="{{ url_for('static', filename='uploads/' ~ tarefa.imagem) }}" alt="Imagem da tarefa" class="tarefa-imagem">
                    {% if current_user.grupo_id == tarefa.grupo_id and not is_past_date %}
                    <form method="POST" action="{{ url_for('main.remover_imagem', id=tarefa.id, date=current_display_date.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="botao-remover-imagem">‚úñ</button>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- A√ß√µes - Desabilitadas se for uma data passada -->
            <div class="acoes {% if is_past_date %}disabled{% endif %}">
                {% if current_user.grupo_id == tarefa.grupo_id and not is_past_date %}
                <form action="{{ url_for('main.enviar_imagem', id=tarefa.id, date=current_display_date.strftime('%Y-%m-%d')) }}" method="POST" enctype="multipart/form-data" class="form-imagem">
                    <label for="imagem-{{ tarefa.id }}" class="botao-imagem">üì∑</label>
                    <input type="file" name="imagem" id="imagem-{{ tarefa.id }}" accept="image/*" style="display: none;" onchange="this.form.submit()">
                </form>
                {% endif %}

                {% if not is_past_date %}
                <a href="{{ url_for('main.concluir', id=tarefa.id, date=current_display_date.strftime('%Y-%m-%d')) }}">
                    {% if tarefa.concluida %}‚úîÔ∏è{% else %}‚úÖ{% endif %}
                </a>
                {% else %}
                    <span class="past-date-completed-icon">{% if tarefa.concluida %}‚úîÔ∏è{% else %}‚ö™{% endif %}</span>
                {% endif %}

                {% if tarefa.usuario_id == current_user.id and not is_past_date %}
                <a href="{{ url_for('main.editar', id=tarefa.id, date=current_display_date.strftime('%Y-%m-%d')) }}">‚úèÔ∏è</a>
                <form action="{{ url_for('main.excluir_tarefa', id=tarefa.id, date=current_display_date.strftime('%Y-%m-%d')) }}" method="POST" style="display: inline;">
                    <button type="submit">üóëÔ∏è</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}

{% endblock %}

{% block scripts %}
    {# --- L√≥gica JavaScript da Navega√ß√£o de Data (espec√≠fica do index.html) --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateDisplayButton = document.getElementById('dateDisplayButton');
            const datePicker = document.getElementById('datePicker');

            if (dateDisplayButton && datePicker) { // Garante que ambos os elementos existam
                dateDisplayButton.addEventListener('click', function() {
                    // Tenta showPicker() primeiro (mais moderno e limpo)
                    if (typeof datePicker.showPicker === 'function') {
                        datePicker.showPicker();
                    } else {
                        // Fallback para navegadores que n√£o suportam showPicker()
                        datePicker.click(); 
                    }
                });

                // Quando uma data √© selecionada no calend√°rio
                datePicker.addEventListener('change', function() {
                    const selectedDate = datePicker.value; // Formato YYYY-MM-DD
                    if (selectedDate) {
                        window.location.href = "{{ url_for('main.index') }}?date=" + selectedDate;
                    }
                });

                // Preenche o campo datePicker com a data atualmente exibida para melhor UX
                const currentDisplayDateStr = "{{ current_display_date.strftime('%Y-%m-%d') }}";
                datePicker.value = currentDisplayDateStr;
            }
        });
    </script>
{% endblock %}